{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block content %}

<!-- Overlay avec barre de progression -->
<div id="loadingOverlay" style="display: none;">
    <div class="loading-container">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Chargement...</span>
        </div>
        <h4 class="mt-3">Traitement en cours...</h4>
        <p>Importation des fichiers CSV</p>
        <div class="progress" style="width: 300px; height: 25px;">
            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                 role="progressbar" style="width: 0%">0%</div>
        </div>
        <p class="mt-2" id="progressText">Initialisation...</p>
    </div>
</div>

<!-- Modal pour afficher les erreurs de conversion -->
<div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title" id="errorModalLabel">
                    <i class="bi bi-exclamation-triangle"></i> Erreurs de conversion d√©tect√©es
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="alert alert-info">
                    <strong>Note :</strong> Les lignes suivantes contiennent des erreurs de conversion.
                    Les valeurs probl√©matiques ont √©t√© remplac√©es par NULL et devront √™tre corrig√©es manuellement.
                </p>
                <div id="errorList"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                <button type="button" class="btn btn-primary" id="continueBtn">Continuer</button>
            </div>
        </div>
    </div>
</div>

<div class="row mt-3 d-flex justify-content-center">
    <div class="col-4">
        <form id="uploadForm" action="" method="POST" class="form" enctype="multipart/form-data">
            {% csrf_token %}
            <label for="annee" class="form-label">Ann√©e</label>
            <input type="text" id="annee" name="annee" class="form-control" value="{{ an }}">
            <label for="file" class="form-label">Choisissez le fichier:</label>
            <input type="file" id="file" name="file" accept=".pdf" class="form-control">
            <div>
                <button id="submitBtn" class="btn btn-primary my-4" type="submit">Charger</button>
            </div>
        </form>
    </div>
</div>


<style>
#loadingOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    z-index: 9999;
    display: flex;
    justify-content: center;
    align-items: center;
}

.loading-container {
    background-color: white;
    padding: 40px;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.loading-container h4 {
    color: #333;
    margin-bottom: 10px;
}

.loading-container p {
    color: #666;
    margin-bottom: 15px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('uploadForm');
    const overlay = document.getElementById('loadingOverlay');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const submitBtn = document.getElementById('submitBtn');
    const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
    const errorList = document.getElementById('errorList');
    const continueBtn = document.getElementById('continueBtn');

    form.addEventListener('submit', function(e) {
        e.preventDefault();

        // V√©rifier qu'un fichier est s√©lectionn√©
        const fileInput = document.getElementById('file');
        if (!fileInput.files.length) {
            alert('Veuillez s√©lectionner un fichier');
            return;
        }

        // Afficher l'overlay
        overlay.style.display = 'flex';
        submitBtn.disabled = true;

        // Simuler la progression (12 fichiers CSV)
        let progress = 0;
        const totalFiles = 12;
        const progressInterval = setInterval(() => {
            if (progress < 90) {
                progress += Math.random() * 15;
                if (progress > 90) progress = 90;

                const currentFile = Math.floor((progress / 90) * totalFiles);
                progressBar.style.width = progress + '%';
                progressBar.textContent = Math.round(progress) + '%';
                progressText.textContent = `Traitement du fichier ${currentFile}/${totalFiles}...`;
            }
        }, 500);

        // Soumettre le formulaire via AJAX
        const formData = new FormData(form);

        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            clearInterval(progressInterval);

            // Compl√©ter la barre
            progressBar.style.width = '100%';
            progressBar.textContent = '100%';
            progressText.textContent = 'Traitement termin√© !';

            setTimeout(() => {
                overlay.style.display = 'none';
                submitBtn.disabled = false;
                progressBar.style.width = '0%';
                progressBar.textContent = '0%';

                if (data.success) {
                    // V√©rifier s'il y a des erreurs de conversion
                    if (data.erreurs && data.erreurs.length > 0) {
                        // Afficher la modal avec les erreurs
                        displayErrors(data);
                        errorModal.show();

                        // G√©rer le clic sur "Continuer"
                        continueBtn.onclick = function() {
                            errorModal.hide();
                            window.location.href = "{% url 'bareme_item' %}";
                        };
                    } else {
                        // Pas d'erreurs, rediriger directement
                        alert(`Import r√©ussi !\n${data.nb_enr} enregistrements cr√©√©s pour l'ann√©e ${data.annee}`);
                        window.location.href = "{% url 'bareme_item' %}";
                    }
                } else {
                    alert('Erreur lors de l\'import : ' + (data.error || 'Erreur inconnue'));
                }
            }, 1000);
        })
        .catch(error => {
            clearInterval(progressInterval);
            console.error('Erreur:', error);
            overlay.style.display = 'none';
            submitBtn.disabled = false;
            alert('Une erreur est survenue lors de l\'import');
        });
    });

    function displayErrors(data) {
        let html = `
            <div class="alert alert-warning">
                <strong>R√©sum√© de l'import :</strong><br>
                ‚úÖ ${data.created} enregistrements cr√©√©s<br>
                üîÑ ${data.updated} enregistrements mis √† jour<br>
                ‚ö†Ô∏è ${data.erreurs.length} erreur(s) de conversion<br>
                ‚ÑπÔ∏è ${data.incomplete} donn√©e(s) incompl√®te(s)
            </div>
            <h6>Liste des erreurs de conversion :</h6>
            <div class="table-responsive">
                <table class="table table-sm table-striped">
                    <thead>
                        <tr>
                            <th>Fichier</th>
                            <th>Localisation</th>
                            <th>Coll√®ge</th>
                            <th>Type</th>
                            <th>Champ</th>
                            <th>Valeur brute</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        data.erreurs.forEach(err => {
            html += `
                <tr>
                    <td><small>${err.fichier || 'N/A'}</small></td>
                    <td><small>${err.localisation || 'N/A'}</small></td>
                    <td><small>${err.college || 'N/A'}</small></td>
                    <td><small>${err.type || 'N/A'}</small></td>
                    <td><small><code>${err.champ || 'N/A'}</code></small></td>
                    <td><small><code>${err.valeur_brute || 'N/A'}</code></small></td>
                </tr>
            `;
        });

        html += `
                    </tbody>
                </table>
            </div>
        `;

        errorList.innerHTML = html;
    }
});
</script>

{% endblock content %}