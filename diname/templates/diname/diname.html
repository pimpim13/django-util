{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %} DiNaMe {% endblock title %}

{% block navitems %}
{% if user.is_staff %}
<li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown"
       aria-expanded="false">
        Parametres
    </a>
    <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
        <li><a class="dropdown-item" href="{% url 'snb_list' %}">SNB...</a></li>
    </ul>
</li>
{% endif %}
{% endblock navitems %}

{% block content %}


<div class="row d-flex">
    <h3 class="h3 bg-secondary text-light text-center" >Calculette DiNaMe</h3>
</div>

<div class="row mt-4 d-flex justify-content-center">
    <div class="col-md-4 col-lg-6">

    <form action="#scroll" method="post" class="form">
        {% csrf_token %}
        <div class="row d-flex justify-content-between ">
        <div class="col-lg-12 col-md-12">
            <div class="card-group">
                <div class="col-lg-12 col-sm-12">
                    <div class="card text-white mt-4 mb-1 mx-1 w-90 bg-secondary">
                        <div  class="card-header h4">Votre situation</div>
                        <div class="card-body d-flex">
                            <div class="col-lg-5 mx-3">
                                {{ form.Nr|as_crispy_field }}
                                {{ form.echelon|as_crispy_field }}
                            </div>
                            <div class="col-lg-5 mx-3">
                                {{ form.tps_trav|as_crispy_field }}
                                {{ form.maj_res|as_crispy_field }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-group">
                <div class="col-lg-12 col-sm-12">
                    <div class="card text-white mt-4 mb-1 mx-1 w-90 bg-secondary">
                        <div  class="card-header h4">Article 30</div>
                        <div class="card-body d-flex">
                            <div class="col-lg-6">
                                {{ form.art30|as_crispy_field }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-group">
                <div class="col-lg-6 col-sm-12">
                    <div class="card h-100 text-white mt-4 mb-1 mx-1 w-90 bg-secondary">
                        <div  class="card-header h4">
                        <button type="button" class="btn btn-outline-light btn-lg" data-bs-toggle="modal" data-bs-target="#AMG_Modal">
                            AMG
                        </button>
                        </div>
                        <div class="card-body">

                            {{ form.eligible_AMG|as_crispy_field }}
                            {{ form.famille|as_crispy_field }}
                            {{ form.site_origine|as_crispy_field }}
                            {{ form.site_destination|as_crispy_field }}

                        </div>
                    </div>
                </div>
                <div class="col-lg-6 col-sm-12">
                    <div class="card h-100 text-white mt-4 mb-1 mx-1 w-90 bg-secondary">
                        <div  class="card-header h4">Logement</div>
                        <div class="card-body">
                            <p>La surface correspondant à votre composition familiale est fixée à :
                                <strong id="js_surface">{{ surface }}</strong> m2

                            <p>L'écart de loyer entre l'ancienne et la nouvelle localisation est de :
                            <strong id="js_ecart_loyer2">{{ ecart_loyer }}</strong> € par m2 par mois, ce qui correspond à une indemnisation de
                            <strong id="js_indemnisation_loyer2">{{ indemnisation_loyer }}</strong> € sur 5 ans</p>
                            <p>En complément l'AMG vous permet d'obtenir une prime de 5 mois de salaire soit
                            <strong id="js_prime_amg2">{{ prime_amg }}</strong> € </p>
                        </div>
                    </div>
                </div>
<!--                <div class="card-group mt-4">-->
                <div class="col-lg-12 col-sm-12 mt-4">
                    <div class="card h-100 text-white mt-4 mb-1 mx-1 w-90">
                        <div  id="js_color" class="card-header h4 {{ attractivite }}">
                        <button type="button" class="btn btn-outline-light btn-lg" data-bs-toggle="modal" data-bs-target="#MGES_Modal">
                            MGES
                        </button>
                        </div>
                        <div class="card-body bg-secondary">
                            <p>Le site destination est considéré comme
                            <strong id="js_lbl_MGES">{{ lbl_MGES}}</strong>
                            <p>et ajoute <strong id="js_moisMGES2">{{ moisMGES }}</strong> mois de salaire</p>
                        </div>
                    </div>
<!--                </div>-->
                </div>
            </div>
             <div class="card-group mt-4">
                <div class="col-lg-12 col-sm-12">
                    <div class="card text-white mt-4 mb-1 mx-1 w-90 bg-secondary">
                        <div  class="card-header h4">
                        <button type="button" class="btn btn-outline-light btn-lg" data-bs-toggle="modal" data-bs-target="#MGEE_Modal">
                            MGEE
                        </button>
                        </div>
                        <div class="card-body d-flex">
                            <div class="col-lg-3">
                                {{ form.eligible_MGEE|as_crispy_field }}
                            </div>
                            <div class="col-lg-9">
                                {{ form.emploi|as_crispy_field }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="d-flex justify-content-end" >
                <input id="fetch-call2" type="submit" value="Calculer" class="btn btn-primary my-3" />
            </div>
        </div>
    </div>
    </form>


</div>
      <div class="col-sm-6 " id="scroll">
        <table class="table table-striped table-hover table-sm">
            <thead>
            <tr>
                <th scope="col">Item</th>
                <th class="text-center" scope="col">Nb Mois</th>
                <th scope="col" class="text-end">Base</th>
                <th scope="col" class="text-end">Total</th>
            </tr>
            </thead>
            <thead>
            <tr>
                <th scope="col">Statut</th>
                <th class="text-center" scope="col"></th>
                <th scope="col"></th>
                <th scope="col"></th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td scope="row">Article 30</td>
                <td class="text-center" id="js_mois_art30">{{ mois_art30 }}</td>
                <td class="text-end" id="js_salaire_mensuel">{{ salaire_mensuel }}</td>
                <td class="text-end" id="js_ind_art30">{{ ind_art30 }}</td>
            </tr>
            <thead>
            <tr>
                <th scope="col">DiNaMe</th>
                <th class="text-center" scope="col"></th>
                <th scope="col"></th>
                <th scope="col"></th>
            </tr>
            </thead>
            <tr>
                <td scope="row">AMG</td>
                <td class="text-center">5</td>
                <td class="text-end" id="js_base_diname_AMG">{{ base_diname }}</td>
                <td class="text-end" id="js_prime_AMG">{{ prime_amg }}</td>
            </tr>
            <tr>
                <td scope="row">MGES</td>
                <td class="text-center" id="js_moisMGES">{{ moisMGES }}</td>
                <td class="text-end" id="js_base_diname_MGES">{{ base_diname }}</td>
                <td class="text-end" id="js_prime_MGES">{{ prime_MGES }}</td>
            </tr>
            <tr>
                <td scope="row">MGEE</td>
                <td class="text-center" id="js_moisMGEE">{{ mois_MGEE }}</td>
                <td class="text-end" id="js_base_diname_MGEE">{{ base_diname }}</td>
                <td class="text-end" id="js_prime_MGEE">{{ prime_MGEE }}</td>
            </tr>
            <thead>
            <tr>
                <th scope="col">Surface</th>
                <th class="text-center" scope="col">m2</th>
                <th scope="col" class="text-end">Ecart/m2</th>
                <th scope="col" class="text-end">Total/5ans</th>
            </tr>
            </thead>
            <tr>
                <td scope="row">Ecart Loyer</td>
                <td class="text-center" id="js_surface2">{{ surface }}</td>
                <td class="text-end" id="js_ecart_loyer">{{ ecart_loyer }}</td>
                <td class="text-end" id="js_indemnisation_loyer">{{ indemnisation_loyer }}</td>
            </tr>
            <thead>
            <tr>
                <th scope="col">Totaux</th>
                <th class="text-center" scope="col"></th>
                <th scope="col"></th>
                <th scope="col"></th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td scope="col">Total Statutaire</td>
                <td class="" scope="col">Art 30</td>
                <td scope="col"></td>
                <td scope="col" class="text-end" id="js_tot_art30">{{ ind_art30 }}</td>
            </tr>
           <tr>
                <td scope="col">Total DiNaMe</td>
                <td class="" scope="col">AMG MGES MGEE Ecart Loyer</td>
                <td scope="col"> (écrêté à 100 000 €)</td>
                <td scope="col" class="text-end" id="js_total_diname">{{ total_diname }}</td>
            </tr>
           <tr>
                <td scope="col">Total Général</td>
                <td class="" scope="col">Art30 + DiNaMe</td>
                <td scope="col"></td>
               <td scope="col" class="text-end" id="js_total_general"><strong>{{ total_general }}</strong></td>
            </tr>
           <tr>
                <td scope="col">Total DiNaMe / an </td>
                <td class="" scope="col">pendant 5 ans en janvier</td>
                <td scope="col">max 20 k€</td>
                <td scope="col" class="text-end" id="js_total_diname_an">{{ total_diname_an }}</td>
            </tr>
            </tbody>

        </table>
   </div>
</div>
<!-- Modal -->
<div class="modal fade" id="MGEE_Modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="ModalLabelMGEE">MGEE Mobilité Encouragée vers certains Emplois</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Si vous gréez un emploi qui fait partie de la liste déroulante, cochez la case "Eligible MGEE".
          Vous ouvrez alors droit à une prime de 2 mois de salaire si déménagement, 1 mois sans déménagement.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="MGES_Modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="ModalLabelMGES">MGES Mobilité Encouragée vers certains Sites</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">Les sites de Rte sont classés en fonction de leur attractivité
          en 4 catégories du plus au moins attractif. La prime d'installation dans un de ces sites
          est de 8, 5 ou 0 mois de salaire pour les sites des moins attractifs aux plus attractifs,
           ou 7 mois pour un site de la région parisienne. </BR>


      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="AMG_Modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="ModalLabelAMG">AMG Accompagnement de la Mobilité Géographique</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">L'indemnisation de la mobilité géographique est composé de 2 partie :
          <ul>
              <li>Une prime de 5 mois de salaire</li>
              <li>Une compensation de l'écart de loyer</li>
          </ul>

          </BR>
          À chaque site correspond un loyer de base au m2. Une indemnisation de l'écart
          de loyer est calculée sur 5 ans dans le cas où le loyer du site de destination est supérieur à
          celui du site d'origine.</BR>
          La surface retenue pour l'indemnisation est fonction de la composition familiale.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>
<!--<script defer src="{% static 'js/script_snb.js' %}"></script>-->
<script>

    document.querySelector('#fetch-call2').addEventListener('click', event => {
          event.preventDefault();
          recalcul();});

    function recalcul(){

      let form = new FormData();
      let csrfTokenValue = document.querySelector('[name=csrfmiddlewaretoken]').value;
      console.log(csrfTokenValue);

      const Nr = document.querySelector('#id_Nr').value
      const maj_res = document.querySelector('#id_maj_res').value
      const tps_trav = document.querySelector('#id_tps_trav').value
      const echelon = document.querySelector('#id_echelon').value
      const art30 = document.getElementById('id_art30').checked

      const eligible_AMG = document.getElementById('id_eligible_AMG').checked
      const eligible_MGEE = document.getElementById('id_eligible_MGEE').checked
      const famille = document.querySelector('#id_famille').value
      const listeOrigine = document.getElementById('id_site_origine')
      const site_origine = listeOrigine.options[listeOrigine.selectedIndex].text
      const listeDest = document.getElementById('id_site_destination')
      const site_destination = listeDest.options[listeDest.selectedIndex].text


      form.append("Nr", Nr);
      form.append("maj_res", maj_res);
      form.append("echelon", echelon);
      form.append("tps_trav", tps_trav);
      form.append("art30", art30);
      form.append("eligible_AMG", eligible_AMG);
      form.append("eligible_MGEE", eligible_MGEE);
      form.append("famille", famille);
      form.append("site_origine", site_origine);
      form.append("site_destination", site_destination);



      console.log(form.get("Nr"))
      console.log(form.get("echelon"))
      console.log(form.get("maj_res"))
      console.log(form.get("tps_trav"))
      console.log(form.get("art30"))
      console.log(form.get("eligible_AMG"))
      console.log(form.get("eligible_MGEE"))
      console.log(form.get("famille"))
      console.log(form.get("site_origine"))
      console.log(form.get("site_destination"))




      let request = new Request("{% url 'recalcul' %}", {method: "POST",
                                                    body: form,
                                                    headers: {"X-CSRFToken": csrfTokenValue}});

      fetch(request)
        .then(response => response.json())
        .then(context => {
            console.log(context["salaire_mensuel"])
            console.log(context["surface"])
            console.log(context["mois_art30"])

            document.querySelector('#js_salaire_mensuel').innerHTML = context["salaire_mensuel"];
            document.querySelector('#js_mois_art30').innerHTML = context["mois_art30"];
            document.querySelector('#js_ind_art30').innerHTML = context["ind_art30"];
            document.querySelector('#js_base_diname_AMG').innerHTML = context["base_diname"];
            document.querySelector('#js_base_diname_MGES').innerHTML = context["base_diname"];
            document.querySelector('#js_base_diname_MGEE').innerHTML = context["base_diname"];
            document.querySelector('#js_prime_AMG').innerHTML = context["prime_amg"];
            document.querySelector('#js_prime_amg2').innerHTML = context["prime_amg"];
            document.querySelector('#js_prime_MGES').innerHTML = context["prime_MGES"];
            document.querySelector('#js_prime_MGEE').innerHTML = context["prime_MGEE"];
            document.querySelector('#js_moisMGES').innerHTML = context["moisMGES"];
            document.querySelector('#js_moisMGEE').innerHTML = context["mois_MGEE"];
            document.querySelector('#js_ecart_loyer').innerHTML = context["ecart_loyer"];
            document.querySelector('#js_ecart_loyer2').innerHTML = context["ecart_loyer"];
            document.querySelector('#js_indemnisation_loyer').innerHTML = context["indemnisation_loyer"];
            document.querySelector('#js_indemnisation_loyer2').innerHTML = context["indemnisation_loyer"];
            document.querySelector('#js_tot_art30').innerHTML = context["ind_art30"];
            document.querySelector('#js_total_diname').innerHTML = context["total_diname"];
            document.querySelector('#js_total_general').innerHTML = context["total_general"];
            document.querySelector('#js_total_diname_an').innerHTML = context["total_diname_an"];
            document.querySelector('#js_lbl_MGES').innerHTML = context["lbl_MGES"];
            document.querySelector('#js_moisMGES2').innerHTML = context["moisMGES"];

            document.querySelector('#js_surface').innerHTML = context["surface"];
            document.querySelector('#js_surface2').innerHTML = context["surface"];

            document.querySelector('#js_color').className = "card-header h4 " + context["attractivite"]



            })
        }

    document.querySelector('#id_Nr').addEventListener('change', event => {recalcul()});
    document.querySelector('#id_echelon').addEventListener('change', event => {recalcul()});
    document.querySelector('#id_maj_res').addEventListener('change', event => {recalcul()});
    document.querySelector('#id_tps_trav').addEventListener('change', event => {recalcul()});
    document.querySelector('#id_art30').addEventListener('change', event => {recalcul()});
    document.querySelector('#id_eligible_AMG').addEventListener('change', event => {recalcul()});
    document.querySelector('#id_eligible_MGEE').addEventListener('change', event => {recalcul()});
    document.querySelector('#id_site_origine').addEventListener('change', event => {recalcul()});
    document.querySelector('#id_site_destination').addEventListener('change', event => {recalcul()});
    document.querySelector('#id_famille').addEventListener('change', event => {recalcul()});



</script>
{% endblock content %}

